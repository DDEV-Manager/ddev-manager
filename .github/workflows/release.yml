name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - 'macos'
          - 'linux-x64'
          - 'linux-arm64'
          - 'windows-x64'
          - 'windows-arm64'
      dry_run:
        description: 'Dry run (build only, no release)'
        required: false
        type: boolean
        default: true

jobs:
  changelog:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || inputs.dry_run != true }}
    outputs:
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          OUTPUT: CHANGELOG.md

  release:
    needs: changelog
    if: ${{ !cancelled() }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macos
            platform: macos-latest
            args: --target universal-apple-darwin
            rust_targets: aarch64-apple-darwin,x86_64-apple-darwin
          - name: linux-x64
            platform: ubuntu-22.04
            args: ''
            rust_targets: ''
          - name: linux-arm64
            platform: ubuntu-22.04
            args: '--target aarch64-unknown-linux-gnu --bundles deb'
            rust_targets: 'aarch64-unknown-linux-gnu'
          - name: windows-x64
            platform: windows-latest
            args: ''
            rust_targets: ''
          - name: windows-arm64
            platform: windows-latest
            args: --target aarch64-pc-windows-msvc
            rust_targets: aarch64-pc-windows-msvc

    runs-on: ${{ matrix.platform }}
    name: Build ${{ matrix.name }}
    steps:
      - name: Check if should run
        id: should_run
        run: echo "skip=${{ inputs.platform != '' && inputs.platform != matrix.name }}" >> $GITHUB_OUTPUT
        shell: bash

      - uses: actions/checkout@v4
        if: steps.should_run.outputs.skip != 'true'

      - name: Setup pnpm
        if: steps.should_run.outputs.skip != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        if: steps.should_run.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Rust
        if: steps.should_run.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      - name: Install Linux dependencies
        if: steps.should_run.outputs.skip != 'true' && contains(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup ARM64 cross-compilation
        if: steps.should_run.outputs.skip != 'true' && matrix.name == 'linux-arm64'
        run: |
          sudo dpkg --add-architecture arm64
          # Restrict existing sources to amd64 only
          sudo sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          # Add arm64 sources from ports.ubuntu.com
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/arm64.list
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu libwebkit2gtk-4.1-dev:arm64 libssl-dev:arm64 librsvg2-dev:arm64 libappindicator3-dev:arm64

      - name: Configure ARM64 environment
        if: steps.should_run.outputs.skip != 'true' && matrix.name == 'linux-arm64'
        run: |
          echo "PKG_CONFIG_SYSROOT_DIR=/usr/aarch64-linux-gnu/" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Install dependencies
        if: steps.should_run.outputs.skip != 'true'
        run: pnpm install

      - name: Build only (dry run)
        if: steps.should_run.outputs.skip != 'true' && inputs.dry_run == true
        run: pnpm tauri build ${{ matrix.args }}

      - name: Build and release
        if: steps.should_run.outputs.skip != 'true' && inputs.dry_run != true
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'DDEV Manager ${{ github.ref_name }}'
          releaseBody: |
            ${{ needs.changelog.outputs.changelog }}

            ## Download

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | macOS | Universal (Intel + Apple Silicon) | `.dmg` |
            | Windows | x64 | `.msi` or `.exe` |
            | Windows | ARM64 | `.exe` |
            | Linux | x64 | `.deb` or `.AppImage` |
            | Linux | ARM64 | `.deb` |

            ---
            **macOS users**: Run `xattr -cr "/Applications/DDEV Manager.app"` if blocked by Gatekeeper.

            **Linux users**: Auto-update only works with AppImage. If you installed via `.deb`, download new versions manually.
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
          updaterJsonPreferNsis: true

      - name: Upload artifacts (dry run)
        if: steps.should_run.outputs.skip != 'true' && inputs.dry_run == true
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.name }}
          path: |
            src-tauri/target/*/release/bundle/**/*
          if-no-files-found: error
